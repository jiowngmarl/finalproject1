{"version":3,"file":"deliveryManagementPage-5r28HpfH.js","sources":["../../../client/src/pages/material/deliveryManagementPage.vue"],"sourcesContent":["<template>\r\n  <div class=\"mrp-page\">\r\n    <h2 class=\"page-title\">자재 출고</h2>\r\n\r\n    <!-- 생산계획 테이블 -->\r\n    <div class=\"table-section\">\r\n      <h3 class=\"table-title\">작업지시 리스트</h3>\r\n      <va-data-table\r\n        :items=\"workList\"\r\n        :columns=\"workColumns\"\r\n        :per-page=\"5\"\r\n        :current-page.sync=\"page\"\r\n        track-by=\"work_order_no\"\r\n      >\r\n        <template #cell(order_start_dt)=\"{ row }\">\r\n          {{ formatToKST(row.source.order_start_dt) }}\r\n        </template>\r\n\r\n        <template #cell(action)=\"{ row }\">\r\n          <va-button size=\"small\" @click=\"onCalculateDe(row.source)\">선택</va-button>\r\n        </template>\r\n      </va-data-table>\r\n    </div>\r\n\r\n    <!-- 부족 자재 리스트 -->\r\n    <div class=\"table-section\">\r\n      <h3 class=\"table-title\">출고 자재 리스트</h3>\r\n      <va-data-table\r\n        :items=\"shortageList\"\r\n        :columns=\"shortageColumns\"\r\n        track-by=\"material_code\"\r\n      />\r\n      <div class=\"button-wrap\">\r\n        <va-button @click=\"onDelivery\" :disabled=\"!selectedWork\">출고</va-button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script lang=\"ts\" setup>\r\nimport axios from 'axios'\r\nimport { ref, onMounted } from 'vue'\r\n\r\ninterface Work {\r\n  work_order_no: string\r\n  product_unit: string\r\n  product_name: string\r\n  product_stand: string\r\n  production_qty: number\r\n  order_start_dt: string\r\n}\r\n\r\ninterface Shortage {\r\n  work_order_no: string\r\n  material_code: string\r\n  material_name: string\r\n  material_unit: string\r\n  quantity: number\r\n  qty: number\r\n  lot_number: string\r\n}\r\n\r\nconst workList = ref<Work[]>([])\r\nconst shortageList = ref<Shortage[]>([])\r\nconst selectedWork = ref<Work | null>(null)\r\nconst page = ref(1)\r\n\r\nconst workColumns = [\r\n  { key: 'work_order_no', label: '요청코드' },\r\n  { key: 'product_unit', label: '단위' },\r\n  { key: 'product_name', label: '제품명' },\r\n  { key: 'product_stand', label: '규격'},\r\n  { key: 'production_qty', label: '요청수량' },\r\n  {\r\n    key: 'order_start_dt',\r\n    label: '요청일자',\r\n    formatter: (value: string) => formatToKST(value)\r\n  },\r\n  { key: 'action', label: '선택' }\r\n]\r\n\r\nconst shortageColumns = [\r\n  { key: 'work_order_no', label: '요청코드' },\r\n  { key: 'material_code', label: '자재코드' },\r\n  { key: 'material_name', label: '자재명' },\r\n  { key: 'material_unit', label: '단위' },\r\n  { key: 'quantity', label: '재고량' },\r\n  { key: 'qty', label: '출고 수량' },\r\n  { key: 'lot_number', label: 'LOT번호' }\r\n]\r\n\r\nconst formatToKST = (isoDate: string): string => {\r\n  const date = new Date(isoDate);\r\n  // KST 적용 (UTC+9)\r\n  const kst = new Date(date.getTime() + 9 * 60 * 60 * 1000);\r\n\r\n  const yyyy = kst.getFullYear();\r\n  const mm = String(kst.getMonth() + 1).padStart(2, '0');\r\n  const dd = String(kst.getDate()).padStart(2, '0');\r\n  const hh = String(kst.getHours()).padStart(2, '0');\r\n  const mi = String(kst.getMinutes()).padStart(2, '0');\r\n\r\n  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;\r\n};\r\n\r\n\r\nconst fetchWork = async () => {\r\n  try {\r\n    const res = await axios.get('/delivery')\r\n    workList.value = res.data\r\n    console.log(res.data);\r\n  } catch (err) {\r\n    console.error('계획 조회 실패', err)\r\n  }\r\n}\r\n\r\nconst onCalculateDe = async (work: Work) => {\r\n  try {\r\n    selectedWork.value = work\r\n    const res = await axios.get(`/delivery/${work.work_order_no}`)\r\n    shortageList.value = res.data\r\n    console.log('응답 데이터:', res.data)\r\n  } catch (err) {\r\n    console.error('계산 실패', err)\r\n  }\r\n}\r\n\r\nconst onDelivery = async (): Promise<void> => {\r\n    if (!selectedWork.value) {\r\n        alert('작업지시를 선택해주세요.')\r\n        return\r\n    }\r\n\r\n    const issuff = shortageList.value.find(\r\n        item => item.qty > item.quantity\r\n    )\r\n\r\n    if(issuff) {\r\n        alert(`자재가 부족합니다.! 발주를 넣어주세요.!!!!`)\r\n        return\r\n    }\r\n\r\n    try {\r\n        const payload = []\r\n        const name = '이승민'\r\n        const workOrderNo = selectedWork.value!.work_order_no\r\n\r\n        for (const item of shortageList.value) {\r\n          const now = new Date()\r\n          const timestamp = now.getFullYear().toString() +\r\n                            (now.getMonth() + 1).toString().padStart(2, '0') +\r\n                            now.getDate().toString().padStart(2, '0') +\r\n                            now.getHours().toString().padStart(2, '0') +\r\n                            now.getMinutes().toString().padStart(2, '0') +\r\n                            now.getSeconds().toString().padStart(2, '0')\r\n\r\n          const random = Math.floor(Math.random() * 1000) // 0~999\r\n          const outboundId = `outbound-${timestamp}-${random}`\r\n\r\n          payload.push({\r\n            outbound_id: outboundId,\r\n            work_order_no: workOrderNo,\r\n            material_code: item.material_code,\r\n            outbound_qty: item.qty,\r\n            name,\r\n            lot_number: item.lot_number,\r\n          })\r\n        }\r\n\r\n        console.log(payload);\r\n\r\n        const res = await axios.post('/delivery', payload) // 출고 이력 등록\r\n\r\n        let allUpdated = true\r\n\r\n        for (const item of shortageList.value) {\r\n          try {\r\n            const response = await axios.put(\r\n              `/delivery/${item.material_code}/${item.lot_number}`,\r\n              {\r\n                quantity: item.quantity - item.qty\r\n              }\r\n            )\r\n\r\n            if (!response.data.isSuccessed) {\r\n              allUpdated = false\r\n            }\r\n          } catch (err) {\r\n            console.error('재고 업데이트 실패:', err)\r\n            allUpdated = false\r\n          }\r\n        }\r\n\r\n        // 작업지시 상태 변경\r\n        const req = await axios.put(`/delivery/${selectedWork.value.work_order_no}`)\r\n\r\n        if (res.data.isSuccessed && allUpdated && req.data.isUpdated) {\r\n          alert('출고가 완료되었습니다.')\r\n          shortageList.value = []\r\n          workList.value = []\r\n          selectedWork.value = null\r\n        } else {\r\n          alert('출고 처리 중 일부 실패가 발생했습니다.')\r\n        }\r\n    } catch (err) {\r\n        console.error('출고 실패', err)\r\n        alert('출고 중 오류가 발생했습니다.')\r\n    }\r\n}\r\n\r\nonMounted(() => {\r\n  fetchWork()\r\n})\r\n</script>\r\n\r\n<style scoped>\r\n.mrp-page {\r\n  padding: 1.5rem;\r\n  max-width: 1000px;\r\n  margin: 0 auto;\r\n}\r\n\r\n.page-title {\r\n  font-size: 1.5rem;\r\n  font-weight: bold;\r\n  margin-bottom: 2rem;\r\n}\r\n\r\n.table-section {\r\n  margin-bottom: 2rem;\r\n}\r\n\r\n.table-title {\r\n  font-size: 1.2rem;\r\n  font-weight: 600;\r\n  margin-bottom: 1rem;\r\n}\r\n\r\n.button-wrap {\r\n  text-align: right;\r\n  margin-top: 1rem;\r\n}\r\n</style>\r\n"],"names":["workList","ref","shortageList","selectedWork","page","workColumns","value","formatToKST","shortageColumns","isoDate","date","kst","yyyy","mm","dd","hh","mi","fetchWork","res","axios","err","onCalculateDe","work","onDelivery","item","payload","name","workOrderNo","now","timestamp","random","outboundId","allUpdated","req","onMounted","_openBlock","_createElementBlock","_hoisted_1","_cache","_createElementVNode","_hoisted_2","_createVNode","_component_va_data_table","_withCtx","row","_createTextVNode","_toDisplayString","_component_va_button","$event","_hoisted_3","_hoisted_4"],"mappings":"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"}