{"version":3,"file":"deliveryManagementPage-BmnrFP_e.js","sources":["../../../client/src/pages/material/deliveryManagementPage.vue"],"sourcesContent":["<template>\n  <div class=\"mrp-page\">\n    <h2 class=\"page-title\">자재 출고</h2>\n\n    <!-- 생산계획 테이블 -->\n    <div class=\"table-section\">\n      <h3 class=\"table-title\">작업지시 리스트</h3>\n      <va-data-table\n        v-model:current-page=\"page\"\n        :items=\"workList\"\n        :columns=\"workColumns\"\n        :per-page=\"5\"\n        track-by=\"work_order_no\"\n      >\n        <template #cell(order_start_dt)=\"{ row }\">\n          {{ formatToKST(row.source.order_start_dt) }}\n        </template>\n\n        <template #cell(action)=\"{ row }\">\n          <va-button size=\"small\" @click=\"onCalculateDe(row.source)\">\n            선택\n          </va-button>\n        </template>\n      </va-data-table>\n    </div>\n\n    <!-- 부족 자재 리스트 -->\n    <div class=\"table-section\">\n      <h3 class=\"table-title\">출고 자재 리스트</h3>\n      <va-data-table\n        :items=\"shortageList\"\n        :columns=\"shortageColumns\"\n        track-by=\"material_code\"\n      />\n      <div class=\"button-wrap\">\n        <va-button :disabled=\"!selectedWork\" @click=\"onDelivery\">\n          출고\n        </va-button>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport axios from \"axios\";\nimport { ref, onMounted } from \"vue\";\n\ninterface Work {\n  work_order_no: string;\n  product_unit: string;\n  product_name: string;\n  product_stand: string;\n  production_qty: number;\n  order_start_dt: string;\n}\n\ninterface Shortage {\n  work_order_no: string;\n  material_code: string;\n  material_name: string;\n  material_unit: string;\n  quantity: number;\n  qty: number;\n  lot_number: string;\n}\n\nconst workList = ref<Work[]>([]);\nconst shortageList = ref<Shortage[]>([]);\nconst selectedWork = ref<Work | null>(null);\nconst page = ref(1);\n\nconst workColumns = [\n  { key: \"work_order_no\", label: \"요청코드\" },\n  { key: \"product_unit\", label: \"단위\" },\n  { key: \"product_name\", label: \"제품명\" },\n  { key: \"product_stand\", label: \"규격\" },\n  { key: \"production_qty\", label: \"요청수량\" },\n  {\n    key: \"order_start_dt\",\n    label: \"요청일자\",\n    formatter: (value: string) => formatToKST(value),\n  },\n  { key: \"action\", label: \"선택\" },\n];\n\nconst shortageColumns = [\n  { key: \"work_order_no\", label: \"요청코드\" },\n  { key: \"material_code\", label: \"자재코드\" },\n  { key: \"material_name\", label: \"자재명\" },\n  { key: \"material_unit\", label: \"단위\" },\n  { key: \"quantity\", label: \"재고량\" },\n  { key: \"qty\", label: \"출고 수량\" },\n  { key: \"lot_number\", label: \"LOT번호\" },\n];\n\nconst formatToKST = (isoDate: string): string => {\n  const date = new Date(isoDate);\n  // KST 적용 (UTC+9)\n  const kst = new Date(date.getTime() + 9 * 60 * 60 * 1000);\n\n  const yyyy = kst.getFullYear();\n  const mm = String(kst.getMonth() + 1).padStart(2, \"0\");\n  const dd = String(kst.getDate()).padStart(2, \"0\");\n  const hh = String(kst.getHours()).padStart(2, \"0\");\n  const mi = String(kst.getMinutes()).padStart(2, \"0\");\n\n  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;\n};\n\nconst fetchWork = async () => {\n  try {\n    const res = await axios.get(\"/delivery\");\n    workList.value = res.data;\n    console.log(res.data);\n  } catch (err) {\n    console.error(\"계획 조회 실패\", err);\n  }\n};\n\nconst onCalculateDe = async (work: Work) => {\n  try {\n    selectedWork.value = work;\n    const res = await axios.get(`/delivery/${work.work_order_no}`);\n    shortageList.value = res.data;\n    console.log(\"응답 데이터:\", res.data);\n  } catch (err) {\n    console.error(\"계산 실패\", err);\n  }\n};\n\nconst onDelivery = async (): Promise<void> => {\n  if (!selectedWork.value) {\n    alert(\"작업지시를 선택해주세요.\");\n    return;\n  }\n\n  const issuff = shortageList.value.find((item) => item.qty > item.quantity);\n\n  if (issuff) {\n    alert(`자재가 부족합니다.! 발주를 넣어주세요.!!!!`);\n    return;\n  }\n\n  try {\n    const payload = [];\n    const name = \"이승민\";\n    const workOrderNo = selectedWork.value!.work_order_no;\n\n    for (const item of shortageList.value) {\n      const now = new Date();\n      const timestamp =\n        now.getFullYear().toString() +\n        (now.getMonth() + 1).toString().padStart(2, \"0\") +\n        now.getDate().toString().padStart(2, \"0\") +\n        now.getHours().toString().padStart(2, \"0\") +\n        now.getMinutes().toString().padStart(2, \"0\") +\n        now.getSeconds().toString().padStart(2, \"0\");\n\n      const random = Math.floor(Math.random() * 1000); // 0~999\n      const outboundId = `outbound-${timestamp}-${random}`;\n\n      payload.push({\n        outbound_id: outboundId,\n        work_order_no: workOrderNo,\n        material_code: item.material_code,\n        outbound_qty: item.qty,\n        name,\n        lot_number: item.lot_number,\n      });\n    }\n\n    console.log(payload);\n\n    const res = await axios.post(\"/delivery\", payload); // 출고 이력 등록\n\n    let allUpdated = true;\n\n    for (const item of shortageList.value) {\n      try {\n        const response = await axios.put(\n          `/delivery/${item.material_code}/${item.lot_number}`,\n          {\n            quantity: item.quantity - item.qty,\n          },\n        );\n\n        if (!response.data.isSuccessed) {\n          allUpdated = false;\n        }\n      } catch (err) {\n        console.error(\"재고 업데이트 실패:\", err);\n        allUpdated = false;\n      }\n    }\n\n    // 작업지시 상태 변경\n    const req = await axios.put(\n      `/delivery/${selectedWork.value.work_order_no}`,\n    );\n\n    if (res.data.isSuccessed && allUpdated && req.data.isUpdated) {\n      alert(\"출고가 완료되었습니다.\");\n      shortageList.value = [];\n      workList.value = [];\n      selectedWork.value = null;\n    } else {\n      alert(\"출고 처리 중 일부 실패가 발생했습니다.\");\n    }\n  } catch (err) {\n    console.error(\"출고 실패\", err);\n    alert(\"출고 중 오류가 발생했습니다.\");\n  }\n};\n\nonMounted(() => {\n  fetchWork();\n});\n</script>\n\n<style scoped>\n.mrp-page {\n  padding: 1.5rem;\n  max-width: 1000px;\n  margin: 0 auto;\n}\n\n.page-title {\n  font-size: 1.5rem;\n  font-weight: bold;\n  margin-bottom: 2rem;\n}\n\n.table-section {\n  margin-bottom: 2rem;\n}\n\n.table-title {\n  font-size: 1.2rem;\n  font-weight: 600;\n  margin-bottom: 1rem;\n}\n\n.button-wrap {\n  text-align: right;\n  margin-top: 1rem;\n}\n</style>\n"],"names":["workList","ref","shortageList","selectedWork","page","workColumns","value","formatToKST","shortageColumns","isoDate","date","kst","yyyy","mm","dd","hh","mi","fetchWork","res","axios","err","onCalculateDe","work","onDelivery","item","payload","name","workOrderNo","now","timestamp","random","outboundId","allUpdated","req","onMounted","_openBlock","_createElementBlock","_hoisted_1","_cache","_createElementVNode","_hoisted_2","_createVNode","_component_va_data_table","$event","_withCtx","row","_createTextVNode","_toDisplayString","_component_va_button","_hoisted_3","_hoisted_4"],"mappings":"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"}