import{d as O,n as b,c as N,f as u,p,i as e,D as g,E as V,F as M,y as U,G as E,t as y,q as D,_ as I,H as B,g as G,x,o as ne,v as h}from"./index-BJgCI8mH.js";const re={key:0,class:"popup-overlay"},ce={class:"popup-content"},de={class:"popup-header"},ue={class:"material-table"},ie=["value"],pe={class:"popup-footer"},_e=O({__name:"MaterialAddPopup",props:{visible:{type:Boolean},materials:{}},emits:["update:visible","add"],setup(w,{emit:_}){const $=w,i=_,C=b(""),d=b([]),l=N(()=>{const v=C.value.trim().toLowerCase();return v?$.materials.filter(n=>n.material_code.toLowerCase().includes(v)||n.material_name.toLowerCase().includes(v)):$.materials});function r(){const v=$.materials.filter(n=>d.value.includes(n.material_code));i("add",v),i("update:visible",!1)}return(v,n)=>v.visible?(u(),p("div",re,[e("div",ce,[e("div",de,[n[3]||(n[3]=e("h3",null,"자재 선택",-1)),g(e("input",{"onUpdate:modelValue":n[0]||(n[0]=f=>C.value=f),placeholder:"자재코드 또는 자재명 검색",class:"search-input"},null,512),[[V,C.value]])]),e("table",ue,[n[4]||(n[4]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"자재코드"),e("th",null,"자재명"),e("th",null,"분류"),e("th",null,"단위"),e("th",null,"규격")])],-1)),e("tbody",null,[(u(!0),p(M,null,U(l.value,f=>(u(),p("tr",{key:f.material_code},[e("td",null,[g(e("input",{"onUpdate:modelValue":n[1]||(n[1]=m=>d.value=m),type:"checkbox",value:f.material_code},null,8,ie),[[E,d.value]])]),e("td",null,y(f.material_code),1),e("td",null,y(f.material_name),1),e("td",null,y(f.material_cls),1),e("td",null,y(f.material_unit),1),e("td",null,y(f.material_stand),1)]))),128))])]),e("div",pe,[e("button",{class:"btn save",onClick:r},"추가"),e("button",{class:"btn",onClick:n[2]||(n[2]=f=>v.$emit("update:visible",!1))}," 닫기 ")])])])):D("",!0)}}),ve=I(_e,[["__scopeId","data-v-2abada63"]]),me={key:0,class:"popup-overlay"},be={class:"popup-content wide"},fe={class:"popup-header"},he={class:"material-table"},ye=["onUpdate:modelValue"],ge=["onUpdate:modelValue","onChange"],$e=["value"],Ce=["onUpdate:modelValue"],ke={class:"popup-footer"},Pe=O({__name:"PopupDetail",props:{visible:{type:Boolean},processCode:{},productCode:{},materialOptions:{},materialList:{},bomCode:{}},emits:["update:visible","save","materialCodeChange","addMaterial","deleteSelectedMaterials"],setup(w,{emit:_}){const $=w,i=b(!1);function C(d){for(const l of d)$.materialList.push({process_code:$.processCode,material_code:l.material_code,material_name:l.material_name,material_unit:l.material_unit,BOM_code:$.bomCode,usage_qty:l.usage_qty??0,responsible:"",selected:!1})}return(d,l)=>d.visible?(u(),p("div",me,[e("div",be,[e("div",fe,[e("div",null,[e("button",{class:"btn add",onClick:l[0]||(l[0]=r=>i.value=!0)}," 재료추가 "),e("button",{class:"btn delete",onClick:l[1]||(l[1]=r=>d.$emit("deleteSelectedMaterials"))}," 재료삭제 ")])]),e("table",he,[l[6]||(l[6]=e("thead",null,[e("tr",null,[e("th",null,[e("input",{type:"checkbox",disabled:""})]),e("th",null,"자재코드"),e("th",null,"자재명"),e("th",null,"단위"),e("th",null,"투입량"),e("th",null,"담당자")])],-1)),e("tbody",null,[(u(!0),p(M,null,U(d.materialList,(r,v)=>(u(),p("tr",{key:v},[e("td",null,[g(e("input",{"onUpdate:modelValue":n=>r.selected=n,type:"checkbox"},null,8,ye),[[E,r.selected]])]),e("td",null,[g(e("select",{"onUpdate:modelValue":n=>r.material_code=n,onChange:n=>d.$emit("materialCodeChange",r)},[l[5]||(l[5]=e("option",{disabled:"",value:""},"자재 선택",-1)),(u(!0),p(M,null,U(d.materialOptions,n=>(u(),p("option",{key:n.material_code,value:n.material_code},y(n.material_code),9,$e))),128))],40,ge),[[B,r.material_code]])]),e("td",null,y(r.material_name),1),e("td",null,y(r.material_unit),1),e("td",null,y(r.usage_qty),1),e("td",null,[g(e("input",{"onUpdate:modelValue":n=>r.responsible=n,type:"text"},null,8,Ce),[[V,r.responsible]])])]))),128))])]),e("div",ke,[e("button",{class:"btn save",onClick:l[2]||(l[2]=r=>d.$emit("save"))},"저장"),e("button",{class:"btn",onClick:l[3]||(l[3]=r=>d.$emit("update:visible",!1))}," 취소 ")]),i.value?(u(),G(ve,{key:0,visible:i.value,materials:d.materialOptions,"onUpdate:visible":l[4]||(l[4]=r=>i.value=r),onAdd:C},null,8,["visible","materials"])):D("",!0)])])):D("",!0)}}),Ve=I(Pe,[["__scopeId","data-v-e8425f80"]]),Me={class:"process-page"},Ue={class:"product-search va-row va-gap-2 va-items-center"},we={class:"times"},Se={class:"product-label"},qe={class:"process-table"},De=["onUpdate:modelValue"],Le=["onUpdate:modelValue"],Be=["onUpdate:modelValue"],Oe=["value"],Ee=["onUpdate:modelValue"],Ie=["value"],Ae={key:1,style:{color:"red"}},Re=["onClick"],Te=O({__name:"processPage",setup(w){const _=b(""),$=b([]),i=b([]),C=b([]),d=b(!1),l=b(""),r=b([]),v=b([]),n=b(""),f=b(""),m=b({product_code:"",product_name:"",product_stand:""}),F=()=>{let t=null;if(m.value.product_code&&(t=$.value.find(c=>c.product_code===m.value.product_code)??null),!t&&m.value.product_name&&m.value.product_stand&&(t=$.value.find(c=>c.product_name===m.value.product_name&&c.product_stand===m.value.product_stand)??null),!t){alert("해당 제품을 찾을 수 없습니다.");return}const s=i.value.length>0,o=_.value&&_.value!==t.product_code;s&&o&&!confirm(`현재 공정 정보를 작성 중입니다.
제품을 변경하시겠습니까?`)||(_.value=t.product_code)},H=()=>{m.value={product_code:"",product_name:"",product_stand:""},_.value="",i.value=[]},S=b([]),j=async()=>{try{const t=await h.get("/processInit");S.value=t.data}catch(t){console.error("❌ 공정 기본 목록 불러오기 실패:",t)}},z=async()=>{try{const t=await h.get("/product");$.value=t.data}catch(t){console.log("❌ 제품 목록 조회 실패:",t)}},J=async()=>{try{const t=await h.get("/common-codes/?groups=0T");C.value=t.data["0T"]||[]}catch(t){console.error("❌ 설비유형 불러오기 실패:",t)}},A=async()=>{try{const t=await h.get(`/bom/processList/${n.value}`);v.value=t.data,f.value=t.data[0].bom_code,console.log("자재:",t.data)}catch(t){console.log("❌ 자재 목록 조회 실패:",t)}},L=async()=>{try{const s=(await h.get(`/process/${_.value}`)).data;i.value=s.map(o=>{const c=S.value.find(a=>a.process_name===o.process_name);return{process_code:o.process_code,process_time:o.process_time,process_name:o.process_name,code_value:o.code_value,process_int:(c==null?void 0:c.process_int)||"",selected:!1}})}catch(t){console.log("❌ 공정정보 조회 실패:",t)}},R=async()=>{try{const s=(await h.get(`/processDetail/${l.value}`)).data;r.value=s.map(o=>{const c=v.value.find(a=>a.material_code===o.material_code);return{process_code:o.process_code||l.value,material_code:o.material_code,BOM_code:o.BOM_code||"",usage_qty:o.usage_qty,responsible:o.name,material_name:(c==null?void 0:c.material_name)||"",material_unit:(c==null?void 0:c.material_unit)||"",selected:!1}})}catch(t){console.log("❌ 상세정보 조회 실패:",t)}};x(l,t=>{t&&R()}),x(_,t=>{t&&L()});const K=t=>{const s=v.value.find(o=>o.material_code===t.material_code);s&&(t.material_name=s.material_name,t.material_unit=s.material_unit,t.usage_qty=s.usage_qty)},Q=N(()=>i.value.reduce((t,s)=>{const o=parseInt(s.process_time.replace(/[^\d]/g,""));return t+(isNaN(o)?0:o)},0)),W=()=>{i.value.push({process_code:"",process_time:"",process_name:"",code_value:"",process_int:"",selected:!1})},X=async()=>{for(const t of i.value)if(t.selected&&t.process_code)try{await h.delete(`/process/${t.process_code}`),console.log(`🗑️ 서버에서 공정 삭제 완료: ${t.process_code}`)}catch(s){console.error(`❌ 공정 삭제 실패: ${t.process_code}`,s),alert(`공정 ${t.process_code} 삭제 실패!`)}i.value=i.value.filter(t=>!t.selected)},Y=()=>{r.value.push({process_code:"",material_code:"",material_name:"",material_unit:"",BOM_code:"",usage_qty:0,responsible:"",selected:!1})},Z=async()=>{for(const t of r.value)if(console.log("✅ 삭제 후보:",t),t.selected&&t.process_code&&t.material_code)try{await h.delete(`/processDetail/${t.process_code}/${t.material_code}`)}catch{}r.value=r.value.filter(t=>!t.selected)},ee=async()=>{try{await h.delete(`/processDetail/${l.value}`),console.log(`✅ ${l.value} 에 해당하는 기존 자재 삭제 완료`)}catch(s){console.error("❌ 기존 자재 삭제 실패:",s),alert("기존 자재 삭제 중 오류 발생!");return}const t=r.value.map(s=>({process_code:l.value,material_code:s.material_code,BOM_code:f.value,name:s.responsible}));console.log("📦 저장할 재료 데이터:",t);try{(await h.post(`/process/${l.value}`,t)).data.isSuccessed===!0?(alert("모든 재료 등록 완료!"),await R()):alert("등록 실패!")}catch(s){console.error("❌ 자재 등록 실패:",s),alert("서버 오류 발생!")}},te=async()=>{const t=[],s=[],o=`${_.value}-Process`,c={process_group_code:o,product_code:_.value};i.value.forEach((a,q)=>{const k=`${_.value}Process${q+1}`,P=S.value.find(ae=>ae.process_int===a.process_int),le=(P==null?void 0:P.process_name)||"",T={process_code:k,process_name:le,process_time:a.process_time,process_seq:q+1,code_value:a.code_value,product_code:_.value,process_group_code:o,process_int:a.process_int};a.process_code?s.push(T):t.push(T)});try{const a=await h.get(`/processG/${o}`),q=Array.isArray(a.data)&&a.data.length>0;if(t.length>0){if(!q&&!(await h.post("/processG",c)).data.isSuccessed)throw new Error("공정 그룹 등록 실패");if(!(await h.post("/process",t)).data.isSuccessed)throw new Error("공정 등록 실패")}for(const k of s)try{(await h.put(`/process/${k.process_code}`,[k])).data.isSuccessed||console.warn(`⚠️ 수정 실패: ${k.process_code}`)}catch(P){console.error(`❌ 수정 중 오류: ${k.process_code}`,P),alert(`공정 수정 중 오류 발생: ${k.process_code}`)}alert("공정 저장 완료!"),await L()}catch(a){console.error("❌ 저장 실패:",a),alert("저장 중 오류 발생!")}},se=(t,s)=>{l.value=t,n.value=s,d.value=!0,A()},oe=(t,s)=>{if(!t){alert("공정을 먼저 저장해야 상세정보를 추가할 수 있습니다.");return}const o=`${_.value}Process${s+1}`;se(o,_.value)};return ne(()=>{z(),J(),A(),L(),j()}),(t,s)=>(u(),p("div",Me,[s[11]||(s[11]=e("h2",{class:"title"},"공정 흐름도 관리",-1)),e("div",Ue,[s[4]||(s[4]=e("label",null,"제품코드: ",-1)),g(e("input",{"onUpdate:modelValue":s[0]||(s[0]=o=>m.value.product_code=o),placeholder:"제품코드 입력"},null,512),[[V,m.value.product_code]]),s[5]||(s[5]=e("label",null,"제품명: ",-1)),g(e("input",{"onUpdate:modelValue":s[1]||(s[1]=o=>m.value.product_name=o),placeholder:"제품명 입력"},null,512),[[V,m.value.product_name]]),s[6]||(s[6]=e("label",null,"규격:",-1)),g(e("input",{"onUpdate:modelValue":s[2]||(s[2]=o=>m.value.product_stand=o),placeholder:"규격 입력"},null,512),[[V,m.value.product_stand]]),e("button",{class:"btn search",onClick:F},"검색"),e("button",{class:"btn reset",onClick:H},"초기화"),e("button",{class:"btn save",onClick:te},"저장")]),e("div",we,[e("span",Se,"총 소요시간: "+y(Q.value)+"분",1)]),e("div",qe,[e("div",{class:"table-header"},[s[7]||(s[7]=e("h3",null,"공정순서",-1)),e("div",null,[e("button",{class:"btn add",onClick:W},"공정추가"),e("button",{class:"btn delete",onClick:X}," 공정삭제 ")])]),e("table",null,[s[10]||(s[10]=e("thead",null,[e("tr",null,[e("th",null,[e("input",{type:"checkbox",disabled:""})]),e("th",null,"순번"),e("th",null,"예상소요시간"),e("th",null,"시험작업"),e("th",null,"설비유형"),e("th",null,"상세추가")])],-1)),e("tbody",null,[(u(!0),p(M,null,U(i.value,(o,c)=>(u(),p("tr",{key:c},[e("td",null,[g(e("input",{"onUpdate:modelValue":a=>o.selected=a,type:"checkbox"},null,8,De),[[E,o.selected]])]),e("td",null,y(c+1),1),e("td",null,[g(e("input",{"onUpdate:modelValue":a=>o.process_time=a,class:"time-input",placeholder:"예: 60분"},null,8,Le),[[V,o.process_time]])]),e("td",null,[g(e("select",{"onUpdate:modelValue":a=>o.process_int=a,class:"name-input"},[s[8]||(s[8]=e("option",{disabled:"",value:""},"공정 명",-1)),(u(!0),p(M,null,U(S.value,a=>(u(),p("option",{key:a.process_int,value:a.process_int},y(a.process_name),9,Oe))),128))],8,Be),[[B,o.process_int]])]),e("td",null,[C.value.length?g((u(),p("select",{key:0,"onUpdate:modelValue":a=>o.code_value=a,class:"equipment-select"},[s[9]||(s[9]=e("option",{disabled:"",value:""},"선택",-1)),(u(!0),p(M,null,U(C.value,a=>(u(),p("option",{key:a.value,value:a.value},y(a.label),9,Ie))),128))],8,Ee)),[[B,o.code_value]]):(u(),p("span",Ae,"🚫 설비 코드 없음"))]),e("td",null,[e("button",{class:"btn save",onClick:a=>oe(o.process_code,c)}," 상세추가 ",8,Re)])]))),128))])])]),d.value?(u(),G(Ve,{key:0,visible:d.value,"process-code":l.value,"product-code":n.value,"material-options":v.value,"material-list":r.value,"bom-code":f.value,"onUpdate:visible":s[3]||(s[3]=o=>d.value=o),onSave:ee,onMaterialCodeChange:K,onAddMaterial:Y,onDeleteSelectedMaterials:Z},null,8,["visible","process-code","product-code","material-options","material-list","bom-code"])):D("",!0)]))}}),Ne=I(Te,[["__scopeId","data-v-c8db73d5"]]);export{Ne as default};
//# sourceMappingURL=processPage-DxRJoKXA.js.map
