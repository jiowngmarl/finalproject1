{"version":3,"file":"deliveryManagementPage-CaUhVYda.js","sources":["../../../client/src/pages/material/deliveryManagementPage.vue"],"sourcesContent":["<template>\n  <div class=\"mrp-page\">\n    <h2 class=\"page-title\">자재 출고</h2>\n\n    <!-- 생산계획 테이블 -->\n    <div class=\"table-section\">\n      <h3 class=\"table-title\">작업지시 리스트</h3>\n      <va-data-table\n        :items=\"workList\"\n        :columns=\"workColumns\"\n        :per-page=\"5\"\n        :current-page.sync=\"page\"\n        track-by=\"work_order_no\"\n      >\n        <template #cell(order_start_dt)=\"{ row }\">\n          {{ formatToKST(row.source.order_start_dt) }}\n        </template>\n\n        <template #cell(action)=\"{ row }\">\n          <va-button size=\"small\" @click=\"onCalculateDe(row.source)\"\n            >선택</va-button\n          >\n        </template>\n      </va-data-table>\n    </div>\n\n    <!-- 부족 자재 리스트 -->\n    <div class=\"table-section\">\n      <h3 class=\"table-title\">출고 자재 리스트</h3>\n      <va-data-table\n        :items=\"shortageList\"\n        :columns=\"shortageColumns\"\n        track-by=\"material_code\"\n      />\n      <div class=\"button-wrap\">\n        <va-button @click=\"onDelivery\" :disabled=\"!selectedWork\"\n          >출고</va-button\n        >\n      </div>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport axios from \"axios\";\nimport { ref, onMounted } from \"vue\";\n\ninterface Work {\n  work_order_no: string;\n  product_unit: string;\n  product_name: string;\n  product_stand: string;\n  production_qty: number;\n  order_start_dt: string;\n}\n\ninterface Shortage {\n  work_order_no: string;\n  material_code: string;\n  material_name: string;\n  material_unit: string;\n  quantity: number;\n  qty: number;\n  lot_number: string;\n}\n\nconst workList = ref<Work[]>([]);\nconst shortageList = ref<Shortage[]>([]);\nconst selectedWork = ref<Work | null>(null);\nconst page = ref(1);\n\nconst workColumns = [\n  { key: \"work_order_no\", label: \"요청코드\" },\n  { key: \"product_unit\", label: \"단위\" },\n  { key: \"product_name\", label: \"제품명\" },\n  { key: \"product_stand\", label: \"규격\" },\n  { key: \"production_qty\", label: \"요청수량\" },\n  {\n    key: \"order_start_dt\",\n    label: \"요청일자\",\n    formatter: (value: string) => formatToKST(value),\n  },\n  { key: \"action\", label: \"선택\" },\n];\n\nconst shortageColumns = [\n  { key: \"work_order_no\", label: \"요청코드\" },\n  { key: \"material_code\", label: \"자재코드\" },\n  { key: \"material_name\", label: \"자재명\" },\n  { key: \"material_unit\", label: \"단위\" },\n  { key: \"quantity\", label: \"재고량\" },\n  { key: \"qty\", label: \"출고 수량\" },\n  { key: \"lot_number\", label: \"LOT번호\" },\n];\n\nconst formatToKST = (isoDate: string): string => {\n  const date = new Date(isoDate);\n  // KST 적용 (UTC+9)\n  const kst = new Date(date.getTime() + 9 * 60 * 60 * 1000);\n\n  const yyyy = kst.getFullYear();\n  const mm = String(kst.getMonth() + 1).padStart(2, \"0\");\n  const dd = String(kst.getDate()).padStart(2, \"0\");\n  const hh = String(kst.getHours()).padStart(2, \"0\");\n  const mi = String(kst.getMinutes()).padStart(2, \"0\");\n\n  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;\n};\n\nconst fetchWork = async () => {\n  try {\n    const res = await axios.get(\"/delivery\");\n    workList.value = res.data;\n    console.log(res.data);\n  } catch (err) {\n    console.error(\"계획 조회 실패\", err);\n  }\n};\n\nconst onCalculateDe = async (work: Work) => {\n  try {\n    selectedWork.value = work;\n    const res = await axios.get(`/delivery/${work.work_order_no}`);\n    shortageList.value = res.data;\n    console.log(\"응답 데이터:\", res.data);\n  } catch (err) {\n    console.error(\"계산 실패\", err);\n  }\n};\n\nconst onDelivery = async (): Promise<void> => {\n  if (!selectedWork.value) {\n    alert(\"작업지시를 선택해주세요.\");\n    return;\n  }\n\n  const issuff = shortageList.value.find((item) => item.qty > item.quantity);\n\n  if (issuff) {\n    alert(`자재가 부족합니다.! 발주를 넣어주세요.!!!!`);\n    return;\n  }\n\n  try {\n    const payload = [];\n    const name = \"이승민\";\n    const workOrderNo = selectedWork.value!.work_order_no;\n\n    for (const item of shortageList.value) {\n      const now = new Date();\n      const timestamp =\n        now.getFullYear().toString() +\n        (now.getMonth() + 1).toString().padStart(2, \"0\") +\n        now.getDate().toString().padStart(2, \"0\") +\n        now.getHours().toString().padStart(2, \"0\") +\n        now.getMinutes().toString().padStart(2, \"0\") +\n        now.getSeconds().toString().padStart(2, \"0\");\n\n      const random = Math.floor(Math.random() * 1000); // 0~999\n      const outboundId = `outbound-${timestamp}-${random}`;\n\n      payload.push({\n        outbound_id: outboundId,\n        work_order_no: workOrderNo,\n        material_code: item.material_code,\n        outbound_qty: item.qty,\n        name,\n        lot_number: item.lot_number,\n      });\n    }\n\n    console.log(payload);\n\n    const res = await axios.post(\"/delivery\", payload); // 출고 이력 등록\n\n    let allUpdated = true;\n\n    for (const item of shortageList.value) {\n      try {\n        const response = await axios.put(\n          `/delivery/${item.material_code}/${item.lot_number}`,\n          {\n            quantity: item.quantity - item.qty,\n          },\n        );\n\n        if (!response.data.isSuccessed) {\n          allUpdated = false;\n        }\n      } catch (err) {\n        console.error(\"재고 업데이트 실패:\", err);\n        allUpdated = false;\n      }\n    }\n\n    // 작업지시 상태 변경\n    const req = await axios.put(\n      `/delivery/${selectedWork.value.work_order_no}`,\n    );\n\n    if (res.data.isSuccessed && allUpdated && req.data.isUpdated) {\n      alert(\"출고가 완료되었습니다.\");\n      shortageList.value = [];\n      workList.value = [];\n      selectedWork.value = null;\n    } else {\n      alert(\"출고 처리 중 일부 실패가 발생했습니다.\");\n    }\n  } catch (err) {\n    console.error(\"출고 실패\", err);\n    alert(\"출고 중 오류가 발생했습니다.\");\n  }\n};\n\nonMounted(() => {\n  fetchWork();\n});\n</script>\n\n<style scoped>\n.mrp-page {\n  padding: 1.5rem;\n  max-width: 1000px;\n  margin: 0 auto;\n}\n\n.page-title {\n  font-size: 1.5rem;\n  font-weight: bold;\n  margin-bottom: 2rem;\n}\n\n.table-section {\n  margin-bottom: 2rem;\n}\n\n.table-title {\n  font-size: 1.2rem;\n  font-weight: 600;\n  margin-bottom: 1rem;\n}\n\n.button-wrap {\n  text-align: right;\n  margin-top: 1rem;\n}\n</style>\n"],"names":["workList","ref","shortageList","selectedWork","page","workColumns","value","formatToKST","shortageColumns","isoDate","date","kst","yyyy","mm","dd","hh","mi","fetchWork","res","axios","err","onCalculateDe","work","onDelivery","item","payload","name","workOrderNo","now","timestamp","random","outboundId","allUpdated","req","onMounted","_openBlock","_createElementBlock","_hoisted_1","_cache","_createElementVNode","_hoisted_2","_createVNode","_component_va_data_table","_withCtx","row","_createTextVNode","_toDisplayString","_component_va_button","$event","_hoisted_3","_hoisted_4"],"mappings":"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"}