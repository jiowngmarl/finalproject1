import{d as ce,n as p,a as ue,c as de,o as ie,p as k,i as t,j as l,w as c,g as b,v as U,h as x,q as D,m as O,t as S,F as pe,y as me,z as L,_ as _e}from"./index-fxpmRMrw.js";const j="equipment_inspection_";function ve(I){try{const _=`${j}${I}`,V=localStorage.getItem(_);return V?JSON.parse(V):null}catch(_){return console.error("점검 데이터 로드 실패:",_),null}}function F(I,_){try{const V=`${j}${I}`;localStorage.setItem(V,JSON.stringify(_))}catch(V){console.error("점검 데이터 저장 실패:",V)}}function ye(I){try{const _=`${j}${I}`;localStorage.removeItem(_)}catch(_){console.error("점검 데이터 삭제 실패:",_)}}const ge={class:"equipment-inspection-page"},fe={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"},qe={class:"flex justify-end gap-2 mt-4"},be={class:"flex items-center"},Ve={class:"font-semibold text-primary cursor-pointer"},he={class:"font-medium"},ke={key:0,class:"text-center py-8 text-secondary"},xe={class:"va-h5"},Se={class:"text-primary"},Ce={class:"grid grid-cols-2 gap-4 mb-4"},Ie={class:"mb-4"},we={class:"flex items-center"},Ee={class:"flex items-center"},Ue={class:"text-sm text-gray-600 mt-2"},Ne={key:0},$e={key:1},De={key:0},Oe={class:"space-y-3"},ze={class:"grid grid-cols-5 gap-4 items-center"},Te={class:"flex items-center"},je={key:1,class:"text-center py-4 text-secondary"},Be={class:"flex justify-end mt-6"},Me=ce({__name:"EquipmentInspection",setup(I){const _=p(null),V=p(null),J=ue(),K=p([{value:"p1",label:"대기 중"},{value:"p2",label:"진행 중"}]),u=p({equipmentCode:"",equipmentName:"",category:"",status:""}),B=p([]),z=p([]),N=p(!1),m=p(null),i=p(!1),v=p([]),y=p({operator_id:"",inspection_type_code:""}),M=p([]),P=p([]),R=p([]),G=p([{value:"n1",text:"공정 전"},{value:"n2",text:"공정 후"},{value:"n3",text:"정기"},{value:"n4",text:"비상"}]),W=de(()=>{var n;const o=(n=m.value)==null?void 0:n.work_status_code,e=K.value.find(s=>s.value===o);return`점검 ${(e==null?void 0:e.label)||"대기 중"}`}),X=[{key:"eq_id",label:"설비번호",sortable:!0},{key:"eq_name",label:"설비명",sortable:!0},{key:"eq_group_name",label:"설비분류",sortable:!0},{key:"eq_run_name",label:"상태",sortable:!0}],Y=o=>({e1:"primary",e2:"success",e3:"warning"})[o]||"secondary",H=o=>({s1:"success",s2:"info",s3:"danger"})[o]||"secondary",$=()=>{var o;(o=m.value)!=null&&o.eq_id&&i.value&&F(m.value.eq_id,{parts:v.value,inspectionData:y.value})},w=()=>{z.value=B.value.filter(o=>!(u.value.equipmentCode&&!o.eq_id.toString().includes(u.value.equipmentCode)||u.value.equipmentName&&!o.eq_name.includes(u.value.equipmentName)||u.value.category&&o.eq_group_code!==u.value.category||u.value.status&&o.eq_run_code!==u.value.status))},T=async()=>{try{const o=await U.get("/equipment-inspection/equipments");o.data.isSuccessed&&(B.value=o.data.data,w())}catch(o){console.error("설비 목록 조회 실패:",o)}},Q=async()=>{try{const o=await U.get("/equipment-inspection/employee");M.value=o.data.map(e=>({value:e.employee_id,label:e.employee_id}))}catch(o){console.error("사원 목록 조회 실패:",o)}},Z=async()=>{try{const e=(await U.get("/common-codes?groups=0E,0S")).data;P.value=e["0E"]||[],R.value=e["0S"]||[]}catch(o){console.error("공통코드 불러오기 실패:",o)}},ee=async(o,e)=>{try{const n=await U.get(`/equipment-inspection/parts/${o}`,{params:{eq_name:e}});v.value=n.data.map(s=>({part_id:s.inspect_part_id,name:s.inspect_part_name,checked:!1,result:"",remark:"",checker_id:""}))}catch(n){console.error("점검 항목 조회 실패:",n)}},oe=async({item:o})=>{var s;if(((s=J.user)==null?void 0:s.department_code)!=="04"){alert("설비팀만 점검을 시작할 수 있습니다.");return}if(console.log("=== 모달 열기 시작 ==="),console.log("선택된 설비 전체 정보:",o),console.log("설비 ID:",o.eq_id),console.log("설비명:",o.eq_name),console.log("설비 그룹 코드:",o.eq_group_code),console.log("설비 유형 코드:",o.eq_type_code),m.value=o,N.value=!0,i.value=!1,y.value={operator_id:"",inspection_type_code:""},console.log("초기화 후 inspectionStarted:",i.value),!o.eq_type_code){console.error("❌ eq_type_code가 없습니다!"),v.value=[];return}console.log("점검 항목 조회 시작 - eq_type_code:",o.eq_type_code),await ee(o.eq_type_code,o.eq_name);const e=`equipment_inspection_${o.eq_id}`;console.log("로컬스토리지 키:",e);const n=ve(o.eq_id);if(console.log("로컬스토리지에서 불러온 데이터:",n),n){console.log("저장된 데이터가 있어서 상태 복원 중...");const g=v.value.map(f=>{const d=n.parts.find(q=>q.part_id===f.part_id);return d?{...f,...d}:f});v.value=g,y.value=n.inspectionData,i.value=!0,console.log("복원 후 inspectionStarted:",i.value),console.log("복원된 점검 항목들:",v.value)}else console.log("저장된 데이터가 없음 - 새로운 점검"),console.log("최종 inspectionStarted:",i.value);console.log("=== 모달 열기 완료 ===")},le=()=>{u.value={equipmentCode:"",equipmentName:"",category:"",status:""},w()},ae=async()=>{var o,e,n;try{const s={eq_id:m.value.eq_id,operator_id:y.value.operator_id,inspection_type_code:y.value.inspection_type_code};if(console.log("점검 시작 요청 데이터:",s),!s.eq_id){alert("설비 정보가 없습니다.");return}if(!s.operator_id){alert("작업자를 선택해주세요.");return}if(!s.inspection_type_code){alert("점검 유형을 선택해주세요.");return}i.value=!0,_.value=new Date().toLocaleString(),alert("점검이 시작되었습니다!"),F(m.value.eq_id,{parts:v.value,inspectionData:y.value});const g=await U.post("/equipment-inspection/start",s);console.log("점검 시작 응답:",g.data),m.value.work_status_code="p2",T()}catch(s){console.error("점검 시작 실패:",s),console.error("에러 응답:",(o=s.response)==null?void 0:o.data),i.value=!1,alert(`점검 시작 실패: ${((n=(e=s.response)==null?void 0:e.data)==null?void 0:n.message)||"알 수 없는 오류"}`)}},te=async()=>{var o,e,n,s,g,f;try{if(console.log("=== 점검 종료 요청 시작 ==="),console.log("설비 ID:",(o=m.value)==null?void 0:o.eq_id),console.log("점검 항목 수:",v.value.length),!((e=m.value)!=null&&e.eq_id)){alert("설비 정보가 없습니다.");return}if(!Array.isArray(v.value)||v.value.length===0){alert("점검 항목이 없습니다.");return}const d=v.value.map(h=>({part_id:h.part_id||null,name:h.name||"",checked:!!h.checked,result:h.result||"",remark:h.remark||"",checker_id:y.value.operator_id||""})).filter(h=>h.part_id!==null);console.log("정리된 점검 항목들:",d);const q={eq_id:m.value.eq_id,parts:d};console.log("점검 종료 요청 데이터:",q);const E=await U.post("/equipment-inspection/end",q);if(console.log("점검 종료 응답:",E.data),E.data.isSuccessed)ye(m.value.eq_id),i.value=!1,N.value=!1,V.value=new Date().toLocaleString(),await T(),alert("점검이 완료되었습니다.");else throw new Error(E.data.message||"점검 종료 실패")}catch(d){console.error("점검 종료 실패:",d),console.error("에러 응답 데이터:",(n=d.response)==null?void 0:n.data),console.error("에러 상태 코드:",(s=d.response)==null?void 0:s.status);let q="점검 종료에 실패했습니다.";(f=(g=d.response)==null?void 0:g.data)!=null&&f.message?q=d.response.data.message:d.message&&(q=d.message),alert(q)}};return ie(()=>{T(),Q(),Z()}),(o,e)=>{const n=b("VaIcon"),s=b("VaInput"),g=b("VaSelect"),f=b("VaButton"),d=b("VaCardContent"),q=b("VaCard"),E=b("VaChip"),h=b("VaDataTable"),se=b("VaCheckbox"),A=b("VaRadio"),ne=b("VaModal");return x(),k("div",ge,[e[16]||(e[16]=t("h1",{class:"va-h3 mb-6"},"설비 점검",-1)),l(q,{class:"mb-6"},{default:c(()=>[l(d,null,{default:c(()=>[e[9]||(e[9]=t("h2",{class:"va-h5 mb-4"},"검색 조건",-1)),t("div",fe,[l(s,{modelValue:u.value.equipmentCode,"onUpdate:modelValue":e[0]||(e[0]=a=>u.value.equipmentCode=a),label:"설비번호",placeholder:"설비번호를 입력하세요",clearable:"",onInput:w},{appendInner:c(()=>[l(n,{name:"search",color:"secondary"})]),_:1},8,["modelValue"]),l(s,{modelValue:u.value.equipmentName,"onUpdate:modelValue":e[1]||(e[1]=a=>u.value.equipmentName=a),label:"설비명",placeholder:"설비명을 입력하세요",clearable:"",onInput:w},{appendInner:c(()=>[l(n,{name:"search",color:"secondary"})]),_:1},8,["modelValue"]),l(g,{modelValue:u.value.category,"onUpdate:modelValue":[e[2]||(e[2]=a=>u.value.category=a),w],label:"설비분류",options:P.value,"text-by":"label","value-by":"value",clearable:"",placeholder:"전체"},null,8,["modelValue","options"]),l(g,{modelValue:u.value.status,"onUpdate:modelValue":[e[3]||(e[3]=a=>u.value.status=a),w],label:"설비상태",options:R.value,"text-by":"label","value-by":"value",clearable:"",placeholder:"전체"},null,8,["modelValue","options"])]),t("div",qe,[l(f,{color:"secondary",onClick:le},{default:c(()=>[t("div",be,[l(n,{name:"refresh",size:"16px",class:"mr-1"}),e[8]||(e[8]=t("span",null,"초기화",-1))])]),_:1})])]),_:1,__:[9]})]),_:1}),l(q,null,{default:c(()=>[l(d,null,{default:c(()=>[e[10]||(e[10]=t("div",{class:"flex justify-between items-center mb-4"},[t("h2",{class:"va-h5"},"설비 목록")],-1)),l(h,{items:z.value,columns:X,hoverable:"",clickable:"","sticky-header":"","onRow:click":oe},{"cell(eq_id)":c(({rowData:a})=>[t("span",Ve,S(a.eq_id),1)]),"cell(eq_name)":c(({rowData:a})=>[t("span",he,S(a.eq_name),1)]),"cell(eq_group_name)":c(({rowData:a})=>[l(E,{color:Y(a.eq_group_code),size:"small",flat:""},{default:c(()=>[O(S(a.eq_group_name||a.eq_group_code),1)]),_:2},1032,["color"])]),"cell(eq_run_name)":c(({rowData:a})=>[l(E,{color:H(a.eq_run_code),size:"small",flat:""},{default:c(()=>[O(S(a.eq_run_name||a.eq_run_code),1)]),_:2},1032,["color"])]),_:1},8,["items"]),z.value.length===0?(x(),k("div",ke," 조회된 설비가 없습니다. ")):D("",!0)]),_:1,__:[10]})]),_:1}),l(ne,{modelValue:N.value,"onUpdate:modelValue":e[7]||(e[7]=a=>N.value=a),size:"large","close-button":!1,"hide-default-actions":""},{header:c(()=>{var a;return[t("h2",xe,[e[11]||(e[11]=O("설비 점검 - ")),t("span",Se,S(((a=m.value)==null?void 0:a.eq_name)||"설비명 없음"),1)])]}),default:c(()=>{var a;return[t("div",Ce,[l(g,{modelValue:y.value.operator_id,"onUpdate:modelValue":e[4]||(e[4]=r=>y.value.operator_id=r),label:"작업자",options:M.value,"text-by":"label","value-by":"value"},null,8,["modelValue","options"]),l(s,{"model-value":(a=m.value)==null?void 0:a.eq_name,label:"설비명",readonly:""},null,8,["model-value"]),l(s,{"model-value":W.value,label:"점검 상태",readonly:""},null,8,["model-value"]),l(g,{modelValue:y.value.inspection_type_code,"onUpdate:modelValue":e[5]||(e[5]=r=>y.value.inspection_type_code=r),label:"점검 유형",options:G.value,"text-by":"text","value-by":"value"},null,8,["modelValue","options"])]),t("div",Ie,[l(f,{onClick:ae,color:"info",class:"mr-2",disabled:i.value},{default:c(()=>[t("div",we,[l(n,{name:"play_arrow",size:"16px",class:"mr-1"}),e[12]||(e[12]=t("span",null,"점검 시작",-1))])]),_:1},8,["disabled"]),l(f,{onClick:te,color:"success",disabled:!i.value},{default:c(()=>[t("div",Ee,[l(n,{name:"stop",size:"16px",class:"mr-1"}),e[13]||(e[13]=t("span",null,"점검 종료",-1))])]),_:1},8,["disabled"]),t("div",Ue,[_.value?(x(),k("div",Ne,"시작 시각: "+S(_.value),1)):D("",!0),V.value?(x(),k("div",$e,"종료 시각: "+S(V.value),1)):D("",!0)])]),v.value.length>0?(x(),k("div",De,[e[14]||(e[14]=t("h3",{class:"va-h6 mb-4 text-primary"},"점검 항목",-1)),t("div",Oe,[(x(!0),k(pe,null,me(v.value,(r,re)=>(x(),k("div",{key:re,class:L(["border rounded p-3",{"bg-gray-50":r.checked}])},[t("div",ze,[t("div",Te,[l(se,{modelValue:r.checked,"onUpdate:modelValue":[C=>r.checked=C,$],label:"선택",disabled:!i.value,color:"primary"},null,8,["modelValue","onUpdate:modelValue","disabled"])]),t("div",{class:L(["font-medium",{"text-primary":r.checked}])},S(r.name),3),t("div",null,[l(A,{modelValue:r.result,"onUpdate:modelValue":[C=>r.result=C,$],option:"j1",label:"적합",class:"mr-2",disabled:!i.value||!r.checked,color:"success"},null,8,["modelValue","onUpdate:modelValue","disabled"]),l(A,{modelValue:r.result,"onUpdate:modelValue":[C=>r.result=C,$],option:"j2",label:"부적합",disabled:!i.value||!r.checked,color:"danger"},null,8,["modelValue","onUpdate:modelValue","disabled"])]),t("div",null,[l(s,{modelValue:r.remark,"onUpdate:modelValue":[C=>r.remark=C,$],placeholder:"비고",disabled:!i.value||!r.checked,color:r.remark?"info":void 0},null,8,["modelValue","onUpdate:modelValue","disabled","color"])])])],2))),128))])])):m.value?(x(),k("div",je," 설비를 선택하면 점검 항목이 표시됩니다. ")):D("",!0),t("div",Be,[l(f,{color:"secondary",onClick:e[6]||(e[6]=r=>N.value=!1)},{default:c(()=>e[15]||(e[15]=[O(" 닫기 ")])),_:1,__:[15]})])]}),_:1},8,["modelValue"])])}}}),Re=_e(Me,[["__scopeId","data-v-cb90e4f0"]]);export{Re as default};
//# sourceMappingURL=EquipmentInspection-D-8p4Agg.js.map
